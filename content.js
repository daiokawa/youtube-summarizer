console.log('[YT Summarizer v2] Extension loaded');

let summarizeButton = null;
let summaryPopup = null;

function createSummarizeButton() {
  if (summarizeButton && document.body.contains(summarizeButton)) {
    return;
  }
  
  summarizeButton = document.createElement('button');
  summarizeButton.id = 'yt-summarize-btn-v2';
  summarizeButton.textContent = '„Åñ„Å£„Åè„Çä';
  summarizeButton.style.cssText = `
    position: fixed !important;
    bottom: 30px !important;
    right: 30px !important;
    z-index: 99999 !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border: none !important;
    border-radius: 50px !important;
    padding: 12px 24px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
    transition: all 0.3s !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
  `;
  
  // „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´Ë®≠ÂÆöÂÆå‰∫Ü
  
  // „Éõ„Éê„Éº„Ç®„Éï„Çß„ÇØ„Éà
  summarizeButton.onmouseover = () => {
    summarizeButton.style.transform = 'scale(1.05)';
  };
  summarizeButton.onmouseout = () => {
    summarizeButton.style.transform = 'scale(1)';
  };
  
  summarizeButton.addEventListener('click', handleSummarizeClick);
  document.body.appendChild(summarizeButton);
  console.log('[YT Summarizer v2] Button created');
}

function createSummaryPopup() {
  if (summaryPopup) {
    summaryPopup.remove();
  }
  
  summaryPopup = document.createElement('div');
  summaryPopup.id = 'yt-summary-popup-v2';
  summaryPopup.style.cssText = `
    position: fixed !important;
    top: 50px !important;
    right: 30px !important;
    width: 550px !important;
    height: 80vh !important;
    max-height: 800px !important;
    background: white !important;
    border-radius: 12px !important;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
    z-index: 100000 !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
  `;
  
  // Êó¢Â≠ò„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÂâäÈô§
  const existingStyle = document.getElementById('chick-bounce-style-v2');
  if (existingStyle) {
    existingStyle.remove();
  }
  
  // Êñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
  const newStyle = document.createElement('style');
  newStyle.id = 'chick-bounce-style-v2';
  newStyle.textContent = `
    @keyframes chickBounceV2 {
      0% { 
        transform: translateX(-30px) translateY(0);
      }
      12.5% {
        transform: translateX(-15px) translateY(-25px);
      }
      25% {
        transform: translateX(0) translateY(0);
      }
      37.5% {
        transform: translateX(15px) translateY(-25px);
      }
      50% {
        transform: translateX(30px) translateY(0);
      }
      62.5% {
        transform: translateX(15px) translateY(-25px);
      }
      75% {
        transform: translateX(0) translateY(0);
      }
      87.5% {
        transform: translateX(-15px) translateY(-25px);
      }
      100% {
        transform: translateX(-30px) translateY(0);
      }
    }
    
    .chick-animation-v2 {
      animation: chickBounceV2 0.6s linear infinite !important;
      display: inline-block;
    }
  `;
  document.head.appendChild(newStyle);
  
  summaryPopup.innerHTML = `
    <div id="popup-header-v2" style="background: #0078d4; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none; border-bottom: 1px solid #005a9e;">
      <span style="font-weight: 600; font-size: 15px;">üê• „Åñ„Å£„Åè„ÇäË¶ÅÁ¥Ñ„Å°„ÇÉ„Çì</span>
      <button id="close-popup-v2" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 28px; height: 28px; border-radius: 4px; display: flex; align-items: center; justify-content: center;">√ó</button>
    </div>
    <div id="popup-content-v2" style="padding: 20px; flex: 1; overflow-y: auto; background: #f8f9fa; position: relative;">
      <div style="text-align: center; color: #666; padding: 40px; padding-top: 80px;">
        <div style="font-size: 18px; margin-bottom: 15px;">„Åñ„Å£„Åè„ÇäË¶ÅÁ¥Ñ‰∏≠...</div>
        <div style="height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 30px;">
          <div class="chick-animation-v2" style="font-size: 50px; font-family: 'Noto Color Emoji', 'Apple Color Emoji', sans-serif;">üê•</div>
        </div>
      </div>
    </div>
    <div id="action-buttons-v2" style="display: none; position: absolute; bottom: 20px; right: 40px; gap: 8px; z-index: 100001;">
      <button id="print-summary-v2" style="background: #0078d4; color: white; border: 1px solid #005a9e; padding: 5px 14px; border-radius: 3px; font-size: 13px; font-weight: normal; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.1s; margin-right: 8px; font-family: 'Segoe UI', sans-serif;">Âç∞Âà∑</button>
      <button id="save-summary-v2" style="background: #0078d4; color: white; border: 1px solid #005a9e; padding: 5px 14px; border-radius: 3px; font-size: 13px; font-weight: normal; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.15); transition: all 0.1s; font-family: 'Segoe UI', sans-serif;">‰øùÂ≠ò</button>
    </div>
  `;
  
  document.body.appendChild(summaryPopup);
  
  // „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ„ÇíËøΩÂä†
  let isDragging = false;
  let currentX;
  let currentY;
  let initialX;
  let initialY;
  let xOffset = 0;
  let yOffset = 0;
  
  const header = document.getElementById('popup-header-v2');
  
  header.addEventListener('mousedown', dragStart);
  document.addEventListener('mousemove', drag);
  document.addEventListener('mouseup', dragEnd);
  
  function dragStart(e) {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    
    if (e.target.id === 'popup-header-v2' || e.target.parentElement.id === 'popup-header-v2') {
      isDragging = true;
    }
  }
  
  function drag(e) {
    if (isDragging) {
      e.preventDefault();
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
      
      xOffset = currentX;
      yOffset = currentY;
      
      summaryPopup.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
  }
  
  function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
  }
  
  // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
  document.getElementById('close-popup-v2').addEventListener('click', () => {
    summaryPopup.remove();
    summaryPopup = null;
  });
}

let isProcessing = false; // Âá¶ÁêÜ‰∏≠„Éï„É©„Ç∞

async function handleSummarizeClick() {
  // Â§öÈáçËµ∑ÂãïÈò≤Ê≠¢
  if (isProcessing) {
    console.log('[YT Summarizer v2] Already processing, skipping...');
    return;
  }
  
  console.log('[YT Summarizer v2] Button clicked');
  isProcessing = true;
  
  // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
  if (summarizeButton) {
    summarizeButton.disabled = true;
    summarizeButton.style.opacity = '0.6';
    summarizeButton.style.cursor = 'not-allowed';
    summarizeButton.textContent = 'Âá¶ÁêÜ‰∏≠...';
  }
  
  createSummaryPopup();
  
  try {
    const videoId = new URLSearchParams(window.location.search).get('v');
    if (!videoId) {
      showError('ÂãïÁîªID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      isProcessing = false; // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      return;
    }
    
    // „Ç∑„É≥„Éó„É´„Å™ÊñπÊ≥ïÔºöÂãïÁîª„ÅÆË™¨ÊòéÊ¨Ñ„ÇíÂèñÂæó
    let description;
    try {
      description = await getVideoDescription();
    } catch (descError) {
      showError('„Åì„ÅÆÂãïÁîª„ÅØË™¨ÊòéÊ¨Ñ„ÅåÁ©∫„ÅÆ„Åü„ÇÅË¶ÅÁ¥Ñ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nË™¨ÊòéÊ¨Ñ„Å´ÂçÅÂàÜ„Å™ÊÉÖÂ†±„Åå„ÅÇ„ÇãÂãïÁîª„Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
      isProcessing = false; // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      return;
    }
    
    const title = document.querySelector('h1.ytd-video-primary-info-renderer')?.textContent || 
                  document.querySelector('#title h1')?.textContent || 
                  'ÂãïÁîª„Çø„Ç§„Éà„É´‰∏çÊòé';
    
    const isTranscript = description.length > 1000 && !description.includes('http');
    const contentType = isTranscript ? '„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà' : 'Ë™¨Êòé';
    const textToSummarize = `„Çø„Ç§„Éà„É´: ${title}\n\n${contentType}: ${description}`;
    console.log('[YT Summarizer v2] Sending to API, text length:', textToSummarize.length);
    
    // Extension context invalidated„Ç®„É©„Éº„ÇíÂá¶ÁêÜ
    if (!chrome.runtime?.id) {
      showError('Êã°ÂºµÊ©üËÉΩ„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Éö„Éº„Ç∏„ÇÇ„É™„É≠„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
      isProcessing = false; // „Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
      return;
    }
    
    chrome.runtime.sendMessage({
      action: 'summarize',
      text: textToSummarize
    }, (response) => {
      // „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
      if (chrome.runtime.lastError) {
        console.error('[YT Summarizer v2] Runtime error:', chrome.runtime.lastError);
        showError('Êã°ÂºµÊ©üËÉΩ„Å®„ÅÆÈÄö‰ø°„Ç®„É©„Éº„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      
      console.log('[YT Summarizer v2] Response:', response);
      console.log('[YT Summarizer v2] Response type:', typeof response);
      console.log('[YT Summarizer v2] Response keys:', response ? Object.keys(response) : 'null');
      console.log('[YT Summarizer v2] Response.error:', response?.error);
      console.log('[YT Summarizer v2] Has error?:', !!response?.error);
      console.log('[YT Summarizer v2] Has summary?:', !!response?.summary);
      
      if (response?.error) {
        console.log('[YT Summarizer v2] Showing error:', response.error);
        showError(response.error);
      } else if (response?.summary) {
        console.log('[YT Summarizer v2] Summary length:', response.summary.length);
        console.log('[YT Summarizer v2] Summary preview:', response.summary.substring(0, 100));
        showSummary(response.summary);
      } else {
        console.log('[YT Summarizer v2] No error or summary in response');
        showError('Ë¶ÅÁ¥Ñ„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„Åå‰∫àÊúü„Åó„Åü„ÇÇ„ÅÆ„Å®Áï∞„Å™„Çä„Åæ„ÅôÔºâ');
      }
    });
  } catch (error) {
    console.error('[YT Summarizer v2] Error:', error);
    if (error.message.includes('Extension context invalidated')) {
      showError('Êã°ÂºµÊ©üËÉΩ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    } else {
      showError(error.message);
    }
    isProcessing = false; // „Ç®„É©„ÉºÊôÇ„ÇÇ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
  }
}

async function getVideoDescription() {
  // „Åæ„ÅöÂ≠óÂπï/„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„ÇíÂèñÂæó„ÇíË©¶„Åø„Çã
  try {
    const transcript = await getTranscript();
    if (transcript && transcript.trim().length > 100) {
      console.log('[YT Summarizer v2] Using transcript, length:', transcript.length);
      return transcript;
    }
  } catch (error) {
    console.log('[YT Summarizer v2] Transcript not available:', error.message);
  }
  
  // Â≠óÂπï„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØË™¨ÊòéÊ¨Ñ„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
  console.log('[YT Summarizer v2] Falling back to description');
  const expandButton = document.querySelector('tp-yt-paper-button#expand');
  if (expandButton) {
    expandButton.click();
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  const description = document.querySelector('#description-inline-expander')?.textContent ||
                     document.querySelector('#description')?.textContent ||
                     document.querySelector('ytd-text-inline-expander')?.textContent ||
                     '';
  
  // Ë™¨ÊòéÊ¨Ñ„ÅåÁ©∫„Åæ„Åü„ÅØÊ•µÁ´Ø„Å´Áü≠„ÅÑÂ†¥Âêà„ÅØ„Ç®„É©„Éº„ÇíÊäï„Åí„Çã
  const cleanedDescription = description.trim();
  if (cleanedDescription.length < 50) {
    throw new Error('Â≠óÂπï„ÇÇË™¨ÊòéÊ¨Ñ„ÇÇÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
  }
  
  return cleanedDescription.substring(0, 3000); // ÊúÄÂàù„ÅÆ3000ÊñáÂ≠ó
}

async function getTranscript() {
  try {
    // „Åæ„ÅöÊó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„Çã„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„Éë„Éç„É´„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
    let transcriptSegments = document.querySelectorAll('ytd-transcript-segment-renderer');
    
    if (transcriptSegments.length === 0) {
      // „Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„Éú„Çø„É≥„ÇíÁõ¥Êé•Êé¢„ÅôÔºà„Çµ„Ç§„Éâ„Éë„Éç„É´ÂÜÖÔºâ
      const transcriptBtn = document.querySelector('ytd-video-description-transcript-section-renderer button') ||
                           document.querySelector('[aria-label*="transcript" i]') ||
                           document.querySelector('[aria-label*="ÊñáÂ≠óËµ∑„Åì„Åó"]');
      
      if (transcriptBtn) {
        transcriptBtn.click();
        await new Promise(resolve => setTimeout(resolve, 1500));
        transcriptSegments = document.querySelectorAll('ytd-transcript-segment-renderer');
      }
    }
    
    if (transcriptSegments.length > 0) {
      // „Çª„Ç∞„É°„É≥„Éà„Åã„ÇâÊñáÂ≠ó„ÇíÁµêÂêà
      const transcriptText = Array.from(transcriptSegments)
        .map(segment => {
          // „Çà„ÇäÊ≠£Á¢∫„Å™„Çª„É¨„ÇØ„Çø
          const textElement = segment.querySelector('.segment-text') ||
                            segment.querySelector('[class*="cue"]') ||
                            segment.querySelector('yt-formatted-string');
          return textElement ? textElement.textContent.trim() : '';
        })
        .filter(text => text.length > 0)
        .join(' ');
      
      if (transcriptText.length > 100) {
        // „Éë„Éç„É´„ÇíÈñâ„Åò„Çã
        const closeBtn = document.querySelector('ytd-engagement-panel-title-header-renderer [aria-label*="Èñâ"]') ||
                        document.querySelector('ytd-engagement-panel-title-header-renderer [aria-label*="Close"]');
        if (closeBtn) closeBtn.click();
        
        return transcriptText.substring(0, 8000);
      }
    }
    
    throw new Error('„Éà„É©„É≥„Çπ„ÇØ„É™„Éó„Éà„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
  } catch (error) {
    console.log('[YT Summarizer v2] Transcript error:', error.message);
    throw error;
  }
}

// HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞
function escapeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function resetButton() {
  isProcessing = false;
  if (summarizeButton) {
    summarizeButton.disabled = false;
    summarizeButton.style.opacity = '1';
    summarizeButton.style.cursor = 'pointer';
    summarizeButton.textContent = '„Åñ„Å£„Åè„Çä';
  }
}

function showSummary(summary) {
  if (!summaryPopup) return;
  
  resetButton(); // „Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
  
  const content = document.getElementById('popup-content-v2');
  
  // Ë¶ÅÁ¥Ñ„Çí‰øùÂ≠òÔºà„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´Ôºâ
  window.currentSummary = summary;
  window.currentVideoTitle = document.querySelector('h1.ytd-video-primary-info-renderer')?.textContent || 
                            document.querySelector('#title h1')?.textContent || 
                            'ÂãïÁîª„Çø„Ç§„Éà„É´';
  window.currentVideoUrl = window.location.href;
  
  // „Éë„Éº„ÉàË¶ãÂá∫„Åó„Å®Êú¨Êñá„ÇíÂá¶ÁêÜÔºàXSSÂØæÁ≠ñÊ∏à„ÅøÔºâ
  const paragraphs = summary.split('\n\n'); // ÊÆµËêΩ„ÅßÂàÜÂâ≤
  let formattedHtml = '';
  
  paragraphs.forEach((paragraph, index) => {
    if (paragraph.trim()) {
      // ÊÆµËêΩÈñì„Å´Âå∫Âàá„ÇäÁ∑ö„ÇíËøΩÂä†ÔºàÊúÄÂàù„ÅÆÊÆµËêΩ‰ª•Â§ñÔºâ
      if (index > 0) {
        formattedHtml += '<hr style="border: none; border-top: 1px solid #e5e7eb; margin: 25px auto; width: 50%;">';
      }
      
      // HTML„Ç®„Çπ„Ç±„Éº„Éó„Åó„Å¶„Åã„ÇâÂõ∫ÊúâÂêçË©û„ÅÆ„Äê„Äë„ÇíÂº∑Ë™øË°®Á§∫
      const escapedText = escapeHTML(paragraph);
      const highlightedText = escapedText.replace(/„Äê([^„Äë]+)„Äë/g, 
        '<strong style="color: #1f2937; background: #fef3c7; padding: 1px 4px; border-radius: 3px;">$1</strong>');
      
      // ÊÆµËêΩÂÖ®‰Ωì„Çí‚ñ∂‰ªò„Åç„ÅßË°®Á§∫
      formattedHtml += `
        <div style="margin-bottom: 20px; position: relative;">
          <span style="position: absolute; left: 0; top: 2px; color: #6366f1; font-weight: bold;">‚ñ∂</span>
          <p style="margin: 0; padding-left: 20px; color: #4b5563; line-height: 1.8; font-size: 14px;">
            ${highlightedText}
          </p>
        </div>
      `;
    }
  });
  
  const formatted = formattedHtml;
  
  content.innerHTML = `
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      ${formatted}
      <div style="height: 80px;"></div><!-- „Éú„Çø„É≥Áî®„ÅÆ„Çπ„Éö„Éº„Çπ -->
    </div>
  `;
  
  // ‰øùÂ≠ò„ÉªÂç∞Âà∑„Éú„Çø„É≥„ÇíË°®Á§∫„Åó„Å¶Ë®≠ÂÆö
  const actionButtons = document.getElementById('action-buttons-v2');
  actionButtons.style.display = 'flex';
  
  // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
  document.getElementById('save-summary-v2').addEventListener('click', saveSummary);
  document.getElementById('print-summary-v2').addEventListener('click', printSummary);
  
  // „Éõ„Éê„Éº„Ç®„Éï„Çß„ÇØ„Éà
  const buttons = actionButtons.querySelectorAll('button');
  buttons.forEach(btn => {
    btn.onmouseover = () => {
      btn.style.background = '#106ebe';
      btn.style.borderColor = '#0062a8';
    };
    btn.onmouseout = () => {
      btn.style.background = '#0078d4';
      btn.style.borderColor = '#005a9e';
    };
  });
}

function showError(error) {
  if (!summaryPopup) return;
  
  resetButton(); // „Ç®„É©„ÉºÊôÇ„ÇÇ„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
  
  const content = document.getElementById('popup-content-v2');
  content.innerHTML = `
    <div style="color: #e74c3c; padding: 20px; background: #fee; border-radius: 8px; text-align: center;">
      <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
      <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">„Ç®„É©„Éº</div>
      <div style="font-size: 14px; line-height: 1.5;">${error.split('\n').join('<br>')}</div>
    </div>
  `;
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂÆüË°å
if (window.location.pathname === '/watch') {
  setTimeout(createSummarizeButton, 2000);
}

// ‰øùÂ≠òÊ©üËÉΩ
function saveSummary() {
  if (!window.currentSummary) return;
  
  const timestamp = new Date().toLocaleString('ja-JP');
  
  // „ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„Åß‰øùÂ≠ò
  const textContent = `YouTubeË¶ÅÁ¥Ñ
=====================================

„Çø„Ç§„Éà„É´: ${window.currentVideoTitle}
URL: ${window.currentVideoUrl}
‰øùÂ≠òÊó•ÊôÇ: ${timestamp}
Ë¶ÅÁ¥ÑÁîüÊàê: GPT-4o-mini

=====================================

${window.currentSummary}`;
  
  // „ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
  const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `YouTubeË¶ÅÁ¥Ñ_${window.currentVideoTitle.replace(/[<>:"/\\|?*]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
  const saveBtn = document.getElementById('save-summary-v2');
  const originalText = saveBtn.textContent;
  saveBtn.textContent = '‚úÖ ‰øùÂ≠òÂÆå‰∫Ü';
  setTimeout(() => {
    saveBtn.textContent = originalText;
  }, 2000);
}

// Âç∞Âà∑Ê©üËÉΩ
function printSummary() {
  if (!window.currentSummary) return;
  
  // Âç∞Âà∑Áî®„Ç¶„Ç£„É≥„Éâ„Ç¶„Çí‰ΩúÊàê
  const printWindow = window.open('', '_blank');
  const timestamp = new Date().toLocaleString('ja-JP');
  
  const printContent = `
    <!DOCTYPE html>
    <html lang="ja">
    <head>
      <meta charset="UTF-8">
      <title>${window.currentVideoTitle} - YouTubeË¶ÅÁ¥Ñ</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
          line-height: 1.8;
          max-width: 800px;
          margin: 40px auto;
          padding: 0 20px;
          color: #333;
        }
        h1 {
          color: #6366f1;
          border-bottom: 2px solid #6366f1;
          padding-bottom: 10px;
          margin-bottom: 20px;
        }
        .meta {
          color: #666;
          font-size: 14px;
          margin-bottom: 30px;
          padding: 10px;
          background: #f5f5f5;
          border-radius: 5px;
        }
        .summary {
          margin-top: 30px;
        }
        .paragraph {
          margin-bottom: 20px;
          padding-left: 20px;
          position: relative;
        }
        .paragraph::before {
          content: '‚ñ∂';
          position: absolute;
          left: 0;
          color: #6366f1;
          font-weight: bold;
        }
        hr {
          border: none;
          border-top: 1px solid #e5e7eb;
          margin: 25px auto;
          width: 50%;
        }
        @media print {
          body {
            margin: 20px;
          }
        }
      </style>
    </head>
    <body>
      <h1>${window.currentVideoTitle}</h1>
      <div class="meta">
        <div>URL: <a href="${window.currentVideoUrl}">${window.currentVideoUrl}</a></div>
        <div>Âç∞Âà∑Êó•ÊôÇ: ${timestamp}</div>
      </div>
      <div class="summary">
        ${window.currentSummary.split('\n\n').map((p, i) => 
          p.trim() ? `
            ${i > 0 ? '<hr>' : ''}
            <div class="paragraph">${p.replace(/„Äê([^„Äë]+)„Äë/g, '<strong>$1</strong>')}</div>
          ` : ''
        ).join('')}
      </div>
    </body>
    </html>
  `;
  
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åè
  setTimeout(() => {
    printWindow.print();
  }, 500);
}

// „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
function cleanupUI() {
  // „Éú„Çø„É≥„ÅÆÂâäÈô§
  if (summarizeButton) {
    summarizeButton.removeEventListener('click', handleSummarizeClick);
    summarizeButton.remove();
    summarizeButton = null;
  }
  // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÂâäÈô§
  if (summaryPopup) {
    summaryPopup.remove();
    summaryPopup = null;
  }
  // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆ„ÇØ„É™„Ç¢
  window.currentSummary = null;
  window.currentVideoTitle = null;
  window.currentVideoUrl = null;
}

// URLÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
let lastUrl = location.href;
new MutationObserver(() => {
  const url = location.href;
  if (url !== lastUrl) {
    cleanupUI(); // „Éö„Éº„Ç∏ÈÅ∑ÁßªÊôÇ„Å´„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
    lastUrl = url;
    if (window.location.pathname === '/watch') {
      setTimeout(createSummarizeButton, 2000);
    }
  }
}).observe(document, {subtree: true, childList: true});